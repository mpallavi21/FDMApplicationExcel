//USEUNIT SMToolFunctionsLibrary
//USEUNIT STDLib
//USEUNIT FDMFunctionsLibrary

var szTestCaseName, szKeywordName, path, xlTemplatePath, szPreviousTestCaseName, szPreviousKeywordName, SheetTC, szPreviousSheetName;
var functionStartTime, name;
var functionEndTime;
var number, paramNum;
var TCStartRow, TCShtRow, inputrow, actualResult;
var Outputfile, screenShotFile;
var param, logsrow;
var inputExcelApp, inputExcelBook;
var resultMessage, executablePath, sheetName, SheetLog, formatStr, resultFlag, url, language, languageExecutionTag, username, password, languageCount,  controlsInfoSheet;
var startUpPage, masterSheet;
var sheetIn, masterSheetRow;
var screenName, testDescription, tcStatus;
var startTime, endTime, execDuration, reportDateTime;
var InputxlApp,InputxlBook,g_FrameworkPath;
var MsExcel,ExcelOpen; 

function main() 
{  
     startTime = new Date();
     resultMessage = "-";       
    // call CheckRecordingRules(1,"Input 1: Door 1 Egress")
    // Initialise starting row of input and result sheets
    
    let outputRow = 3;
    let outputRowResultSheet = 2;    
     executablePath = Project.Path;
    // Append results to the path obtained from registry for the result file
     Outputfile = executablePath + "Results\\";
     g_FrameworkPath = executablePath + "Framework.xlsx";
    // Initialise high level and low level result sheet names
    let sheetResult = "Result";
     SheetLog = "LL_Results";  
     startUpPage = "Startup_Page";
     MasterSheet_Row = 2;
     MasterSheet = "Master";
     logsrow = 1;
 
   MsExcel =  openExcelFile(g_FrameworkPath)   // Check for Excel file Opening    
   InputxlApp=MsExcel
    let szScreenName = ReadExcelData(InputxlApp, MasterSheet, MasterSheet_Row, 1);
    
    while (szScreenName.toUpperCase() !== "") 
    {               
        if (ReadExcelData(MsExcel, MasterSheet, MasterSheet_Row, 2) == 1) 
        {
             outrow_Resultsheet = 2;
             SheetTC = szScreenName;
             SheetIn = szScreenName + "_input";
             TCShtRow = 2;

            // Call ConfigureNewAlarmSystem(InputxlApp,"Experion/TPS - Honeywell","Fieldbus","Fieldbus","dfdf","df","gghg")
             szTestCaseName = ReadExcelData(InputxlApp, SheetTC, TCShtRow, 1);
            let nColorIndex;
            // nColorIndex = InputxlApp.Sheets(SheetTC).cells(nRow, nCol).Interior.ColorIndex
            let szTestCaseExpectedOp = ReadExcelData(InputxlApp, SheetTC, TCShtRow, 1);
            // Loop till "<END_SHEET>" tag Reached
            while (szTestCaseName.toUpperCase() !== "") {
                if (szTestCaseName.toUpperCase() !== "") {
                    // Get execution condition of testcase
                    let szTagName = "<" + szTestCaseName + ">";
                    let szTCExecTag = ReadExcelData(InputxlApp, SheetTC, TCShtRow, 2);              
                    let szTestDescription = ReadExcelData(InputxlApp, SheetTC, TCShtRow, 3);
                    let szTCStatus = "Pass";
                    // Check for Execute condition of TestCases = 1
                    if (szTCExecTag == 1) {    
                      
                        // Call SetValueToExcel(InputxlApp,SheetResult,outrow_Resultsheet,1,szTestCaseName)  
                        let StepNo = 0;
                        let TCStartRow = outputRow;       
                        let nCount = InputxlApp.Sheets.Item(SheetIn).UsedRange.Rows.Count;        
                        for ( i = 1; i <= nCount; i++) {
                            if (InputxlApp.Sheets.Item(SheetIn).Cells.Item(1).Item(i) == szTagName) {
                                inputrow = i;
                                TCStartRow = inputrow;
                                break;
                            }
                        }
                        
                        inputrow = inputrow + 1;
                        // Read keyword name In testcase
                         szKeywordName = ReadExcelData(InputxlApp, SheetIn, inputrow, 1);
                        
                        // Check for the End of TestCases
                        while (szKeywordName !== "<ENDCASE>") {
                            let szParameter = "";
                            // Read keyword name
                            szKeywordName = szKeywordName.trim(ReadExcelData(InputxlApp, SheetIn, inputrow, 1));
    
                            // Check for blank line
                            if (szKeywordName.toUpperCase() !== "") {
                                let nparamnum = trim(ReadExcelData(InputxlApp, SheetIn, inputrow, 2));
                                if (nparamnum !== "") {
                                    let j = inputrow;
                                    // Collect Parameters from the Input framework sheet
                                    let Parameters = new Array(nparamnum - 1);
                                    for ( Number = 0; Number < parseInt(nparamnum); Number++) {  
                                        j += 1;                              
                                        Parameters[Number] = ReadExcelData(InputxlApp, SheetIn, j, 3);
                                    }
                                    let szDesc = "";
                                                 
                                    switch (szKeywordName.toUpperCase()) {
                                        case "LAUNCHSERVERMANAGMENTTOOL":                                                   
                                              LaunchServerManagmentTool(Parameters[0],Parameters[1],Parameters[2])                                          
                                            break;
                                        case "TERMINATESERVERTOOL":
                                              TerminateServerTool()
                                            break;
                                        case "VALIDATEINVALIDPASSWORDSCENARIO":
                                              validateInvalidPasswordScenario(Parameters[0],Parameters[1])
                                            break;
                                        case "verifyCopyrightAndBranding":
                                              verifyCopyrightAndBranding(Parameters[0])
                                            break;
                                        case "VALIDATEBLANKLOGINFIELDS":
                                              validateBlankLoginFields(Parameters[0],Parameters[1]) 
                                            break; 
                                        case "VERIFYCANCELBUTTONBEHAVIOR":
                                              verifyCancelButtonBehavior(Parameters[0],Parameters[1],Parameters[2]) 
                                            break;
                                        case "STOPSTARTSERVERVIADASHBOARDUI":
                                              stopStartServerViaDashboardUI(Parameters[0],Parameters[1],Parameters[2],Parameters[3])
                                            break;
                                        case "ADDNETWORK":
                                              addNetwork({
                                                NetworkName: Parameters[0],
                                                RCIName: Parameters[1],
                                                NetworkType: Parameters[2],
                                                EnableMux: Parameters[3],             // Only used for RS-485 Hart Multiplexer
                                                ComportType: Parameters[4],           // Only used for RS-485 Hart Multiplexer
                                                BaudRateType: Parameters[5],          // Only used for RS-485 Hart Multiplexer
                                                Redundency: Parameters[6],            // Only used for Honeywell Experion PKS
                                                SecondaryServerName: Parameters[7],   // Only used for Honeywell Experion PKS
                                                SafetyBoolean: Parameters[8],         // Only used for Honeywell Experion PKS
                                                OneWirelessBoolean: Parameters[9]     // Only used for Honeywell Experion PKS
                                              });
                                            break;
                                        case "DELETENETWORK":
                                              deleteNetwork(Parameters[0])
                                            break;
                                        case "UPDATESERVERLICENSE":
                                              updateServerLicense(Parameters[0],Parameters[1])
                                            break;
                                        case "LAUNCHFDMCLIENTAPPLICATION":
                                              launchFDMClientApplication(Parameters[0],Parameters[1],Parameters[2])
                                            break;
                                        case "TERMINATEFDMCLIENTAPPLICATION":
                                              terminateFDMClientApplication()
                                            break;
                                        case "BUILDNETWORK":
                                              BuildNetwork(Parameters[0],Parameters[1])
                                            break;
                                        case "STARTSERVICESDRFDM":
                                              startServicesDRFDM()
                                            break;
                                        case "STOPSERVICESDRFDM":
                                              stopServicesDRFDM()
                                            break;
                                        case "COLLECTLOGSFROMDRFDM":
                                              collectLogsFromDrFDM()
                                            break;
                                        case "VIEWAUDITTRAILFORDEVICE":
                                              ViewAuditTrailForDevice(Parameters[0],Parameters[1])
                                            break;
                                        case "AUDITTRAILVIAMENUTAB":
                                              auditTrailViaMenuTab()
                                            break;
                                        case "CLICKONNETWORKVIEWTAB":
                                              clickOnNetworkViewTab()
                                            break;
                                        case "CLICKONLINEVIEW":
                                              ClickOnlineView();
                                            break;
                                        case "ADDDD":
                                              AddDD(Parameters[0],Parameters[1]);
                                            break;
                                        case "DELETEDD":
                                              DeleteDD(Parameters[0],Parameters[1],Parameters[2],Parameters[3],Parameters[4]);
                                            break;
                                        case "LOADDEVICE":
                                              LoadDevice(Parameters[0]);
                                            break;
                                        case "SAVEHISTORY":
                                              SaveHistory()
                                            break;
                                        case "QUICKVIEWOFDEVICE":
                                              QuickViewOfDevice(Parameters[0])
                                            break;
                                        case "ATTACHAPP":
                                              AttachApp(Parameters[0],Parameters[1])
                                            break;
                                        case "DETACHAPP":
                                              DetachApp()
                                            break;
                                        case "ATTACHDEVICEDOCUMENTATION":
                                              AttachDeviceDocumentation(Parameters[0],Parameters[1],Parameters[2])
                                            break;
                                        case "DETACHDEVICEDOCUMENTATION":
                                              DetachDeviceDocumentation(Parameters[0])
                                            break;
                                        case "DEVICEPARAM":
                                              DeviceParam(Parameters[0])
                                            break;
                                        case "UPDATEDTMLIBRARY":
                                              UpdateDTMLibrary()
                                            break;
                                        case "READANDWRITEDEVICEPROPERTIES":
                                              ReadAndWriteDeviceProperties(Parameters[0],Parameters[1],Parameters[2],Parameters[3])
                                            break;
                                        case "PRINTTHEDEVICE":
                                              PrintTheDevice(Parameters[0])
                                            break;
                                        case "LOGUSERACTION":
                                              LogUserAction(Parameters[0])
                                            break;
                                        case "DEVICEEXPLICITLOCK":
                                              Device_Explicit_Lock(Parameters[0]);
                                            break;
                                        case "DEVICEEXPLICITUNLOCK":
                                              Device_Explicit_UnLock(Parameters[0]);
                                            break;
                                        case "GETDEVICESTATEVIEW":
                                              GetDeviceStateView(Parameters[0])
                                            break;
                                        case "ATTACHSYSTEMDOCUMENT":
                                              AttachSystemDocument(Parameters[0])
                                            break;
                                        case "DETACHSYSTEMDOCUMENT":
                                              DetachSystemDocument() 
                                            break;
                                        case "CHECKFDMDEVICEPROPERTYOPTION":
                                              CheckFDMDevicePropertyOption(Parameters[0])
                                            break;
                                        case "VALIDATEDEVICEHISTORYRECORDS":
                                              ValidateDeviceHistoryRecords(Parameters[0])
                                            break;
                                        case "OPTIONSFUNCTION":
                                              OptionsFunction(Parameters[0])
                                            break;
                                        case "DEVICEICONSCREATEDISPLAYFILTER":
                                              DeviceIconsCreateDisplayFilter(Parameters[0])
                                            break;
                                        case "DELETEDISPLAYFILTERITEM":
                                              DeleteDisplayFilterItem(Parameters[0])
                                            break;
                                        case "DEVICEICONSCREATEDTMOFFLINECONFIG":
                                              DeviceICONSCreateDTMOfflineConfig()
                                            break;
                                        case "DEVICEICONSDDOFFLINEVIEW":
                                              DeviceIconsDDOfflineView()
                                            break;
                                        case "DEVICEICONSLIBRARYVIEW":
                                              DeviceIconsLibraryView()
                                            break;
                                        case "OFFLINEDDCREATECONFIGURATION":
                                              OfflineDDCreateConfiguration(Parameters[0],Parameters[1],Parameters[2],Parameters[3],Parameters[4],Parameters[5],Parameters[6])
                                            break;
                                        case "LAUNCHPAVDASHBOARD":
                                              LaunchPAVDashboard()
                                            break; 
                                        case "LAUNCHALERTMONITORING":
                                              LaunchAlertMonitoring()
                                            break;
                                        case "DIAGNOSTICMODELTABFDMVIEW":
                                              DiagnosticModelTabFDMView()
                                            break;
                                        case "VALIDATECREATEDIAGNOSTICMODEL":
                                              validateCreateDiagnosticModel(Parameters[0],Parameters[1],Parameters[2],Parameters[3],Parameters[4])
                                            break;
                                        case "VALIDATEDELETEDIAGNOSTICMODELHART":
                                              validateDeleteDiagnosticModelHART()
                                            break;
                                        case "VALIDATEDELETEDIAGNOSTICMODELFF":
                                              validateDeleteDiagnosticModelFF()
                                            break;
                                        case "VERIFYOFFLINECONFIGURATIONSAVEFORFFDEVICES":
                                              verifyOfflineConfigurationSaveForFFDevices()
                                            break;
                                        case "EXPORTANDIMPORTDEVICETAGS":
                                              ExportAndImportDeviceTags()
                                            break;
                                        case "EXPORTANDIMPORTAUDITTRAIL":
                                              ExportAndImportAuditTrail()
                                            break;
                                        case "ADVANCECONFIGURATION":
                                              advanceConfiguration(Parameters[0],Parameters[1],Parameters[2])
                                            break;
                                        default:
                                            Delay(2000);
                                            break;
                                    } // End of keyword Selection   

                                    let szStatus = ""; 
                                } // Blank line
                            }
                            // Increment TCShtRow and read the next keyword
                            inputrow = inputrow + 1;
                            szKeywordName = ReadExcelData(InputxlApp, SheetIn, inputrow, 1);     
                            
                            // To Write the Test Case Result
                            if (szKeywordName === "<ENDCASE>") {                  
                                szKeywordName = ReadExcelData(InputxlApp, SheetIn, inputrow, 1);
                                
                              //  HighLevelResultsheet(InputxlApp, SheetIn, szTestCaseName, szTCStatus); // write to result sheet
                               // GenrateHTMLFile(InputxlApp);   
                               // ExcelToHtmlTable(InputxlApp, "C:\\Temp\\log.html");
                            }
                        }                                   
                    } // Execute Condition
                } // condition for <                                            
                TCShtRow += 1;  // To Increase the row number to read test case name.   
                szTestCaseName = ReadExcelData(InputxlApp, SheetTC, TCShtRow, 1);
                szTCExecTag = ReadExcelData(InputxlApp, SheetTC, TCShtRow, 2);                
            } // Loop till <TC/> tag Reached
            // Check if the End of the Input Sheet Reached
//             if (szTestCaseName.toUpperCase() === "") {
//                 WriteResultToExcel(InputxlApp, SheetLog, outputrow, szTestCaseName);
//             }       
        }
        MasterSheet_Row += 1;
        szScreenName = ReadExcelData(InputxlApp, MasterSheet, MasterSheet_Row, 1);     
    }

// Excel Parsing Part
let timestamp = Get_date_time();
let szName = Outputfile + String(timestamp) + ".xlsx";

//InputxlApp.DisplayAlerts = false;
InputxlApp.SaveAs(szName); // As Openexcelfile

// Closing all open Framework applications
let Ret = InputxlApp.Close();

var i;
// Displaying Execution End
killExcelIfRunning()
BuiltIn.ShowMessage("TEST EXECUTION COMPLETE")

// Display Result sheet
openExcelFile(szName,true);
//DeleteExcelSheet(InputxlApp, "ControlsInfo");      
//InputxlApp.SaveAs(szName); // As Openexcelfile 


}

function killExcelIfRunning() {
  var excelProc = Sys.Process("EXCEL");
  if (excelProc.Exists) {
    excelProc.Terminate();
    Log.Message("✅ Excel process terminated to release file lock.");
  }
}
